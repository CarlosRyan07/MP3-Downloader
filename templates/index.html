<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Downloader de √Åudio</title>
  
  <!-- Link para seu CSS -->
  <link rel="stylesheet" href="/static/style.css">
  
  <!-- Estilos espec√≠ficos para a tela de splash -->
  <style>
    /* Tela de splash que cobre toda a janela */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #393c3a; /* verde */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    /* Ajustes na anima√ß√£o "Hi!" */
    h1.ml8 {
      font-weight: 900;
      font-size: 4.5em;
      color: #fff; /* Voc√™ pode alterar para outra cor se preferir */
      width: 3em;
      height: 3em;
      position: relative;
    }
    .ml8 .letters-container {
      position: absolute;
      left: 0;
      right: 0;
      margin: auto;
      top: 0;
      bottom: 0;
      height: 1em;
    }
    .ml8 .letters {
      position: relative;
      z-index: 2;
      display: inline-block;
      line-height: 0.7em;
      right: -0.12em;
      top: -0.2em;
    }
    .ml8 .bang {
      font-size: 1.4em;
      top: auto;
      left: -0.06em;
    }
    .ml8 .circle {
      position: absolute;
      left: 0;
      right: 0;
      margin: auto;
      top: 0;
      bottom: 0;
    }
    .ml8 .circle-white {
      width: 3em;
      height: 3em;
      border: 2px dashed white;
      border-radius: 2em;
    }
    .ml8 .circle-dark {
      width: 2.2em;
      height: 2.2em;
      background-color: #09b30f;
      border-radius: 3em;
      z-index: 1;
    }
    .ml8 .circle-dark-dashed {
      border-radius: 2.4em;
      background-color: transparent;
      border: 2px dashed #10b015;
      width: 2.3em;
      height: 2.3em;
    }
  </style>
  
  <!-- Incluindo a biblioteca Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
  <!-- Incluindo a biblioteca Canvas Confetti (para outras anima√ß√µes, se necess√°rio) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <!-- Tela de Splash com anima√ß√£o "Hi!" -->
  <div id="splash">
    <h1 class="ml8">
      <span class="letters-container">
        <span class="letters letters-left">Ol√°</span>
        <span class="letters bang">!</span>
      </span>
      <span class="circle circle-white"></span>
      <span class="circle circle-dark"></span>
      <span class="circle circle-container">
        <span class="circle circle-dark-dashed"></span>
      </span>
    </h1>
  </div>
  
  <!-- Conte√∫do principal (inicialmente oculto) -->
  <div id="mainContent" style="display: none;">
    <header class="header">
      <h1>Downloader de √Åudio</h1>
      <p>Baixe m√∫sica ou playlists inteiras de forma r√°pida e f√°cil.</p>
      <button id="theme-toggle">Alternar Tema</button>
    </header>
    <main class="container">
      <section class="download-section">
        <form id="download-form">
          <label for="url">Insira a URL do V√≠deo ou Playlist:</label>
          <input type="text" id="url" name="url" placeholder="Digite a URL aqui" required>
          <label for="format">Formato</label>
          <input id="format" name="format" value="MP3" readonly>
          <button id="download-btn" type="submit">Download</button>
          <div class="spinner" id="spinner"></div>
        </form>
      </section>
      
      <!-- Se√ß√£o para informa√ß√µes da m√∫sica - Oculta por padr√£o -->
      <section class="info-section" id="info-section" style="display: none;">
        <h2>Informa√ß√µes da M√∫sica</h2>
        <p id="music-info">Nenhuma informa√ß√£o dispon√≠vel.</p>
        <img id="thumbnail" src="" alt="" style="max-width: 80%; height: auto;">
      </section>
  
      <section class="status-section">
        <h2>Downloads Realizados:</h2>
        <p id="status">N√£o h√° download em andamento.</p>
        <div id="progress-bar">
          <div id="progress"></div>
        </div>
        <div id="downloads-list"></div>
      </section>
    </main>
  </div>
  
  <!-- Incluindo o Socket.io -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    /* Anima√ß√£o de Splash usando Anime.js */
    anime.timeline({loop: false})
      .add({
        targets: '.ml8 .circle-white',
        scale: [0, 3],
        opacity: [1, 0],
        easing: "easeInOutExpo",
        rotateZ: 360,
        duration: 1100
      }).add({
        targets: '.ml8 .circle-container',
        scale: [0, 1],
        duration: 1100,
        easing: "easeInOutExpo",
        offset: '-=1000'
      }).add({
        targets: '.ml8 .circle-dark',
        scale: [0, 1],
        duration: 1100,
        easing: "easeOutExpo",
        offset: '-=600'
      }).add({
        targets: '.ml8 .letters-left',
        scale: [0, 1],
        duration: 1200,
        offset: '-=550'
      }).add({
        targets: '.ml8 .bang',
        scale: [0, 1],
        rotateZ: [45, 15],
        duration: 1200,
        offset: '-=1000'
      }).add({
        targets: '.ml8',
        opacity: 0,
        duration: 1000,
        easing: "easeOutExpo",
        delay: 1400
      });
  
    anime({
      targets: '.ml8 .circle-dark-dashed',
      rotateZ: 360,
      duration: 8000,
      easing: "linear",
      loop: true
    });
  
    // Quando a anima√ß√£o de splash terminar, ocultamos o splash e mostramos o conte√∫do principal.
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }, 5000); // Ajuste o tempo conforme necess√°rio (5000ms = 5 segundos)
  
    /* --- C√≥digo Original do Projeto (Download, socket.io, etc.) --- */
    const form = document.getElementById("download-form");
    const statusElement = document.getElementById("status");
    const progressBar = document.getElementById("progress");
    const downloadsList = document.getElementById("downloads-list");
    const downloadButton = document.getElementById("download-btn");
    const urlInput = document.getElementById("url");
    const musicInfo = document.getElementById("music-info");
    const thumbnail = document.getElementById("thumbnail");
    const themeToggle = document.getElementById("theme-toggle");
    const infoSection = document.getElementById("info-section");
  
    const socket = io();
    let progressInterval;
    let startTime;

    // Fun√ß√£o para disparar confetes
    var count = 200;
    var defaults = {
      origin: { y: 0.7 }
    };

    function fire(particleRatio, opts) {
      confetti({
        ...defaults,
        ...opts,
        particleCount: Math.floor(count * particleRatio)
      });
    }

    function triggerConfetti() {
      fire(0.25, {
        spread: 26,
        startVelocity: 55,
      });
      fire(0.2, {
        spread: 60,
      });
      fire(0.35, {
        spread: 100,
        decay: 0.91,
        scalar: 0.8
      });
      fire(0.1, {
        spread: 120,
        startVelocity: 25,
        decay: 0.92,
        scalar: 1.2
      });
      fire(0.1, {
        spread: 120,
        startVelocity: 45,
      });
    }
  
    // Fun√ß√£o para alternar tema (claro/escuro)
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("light-theme");
      const isLightTheme = document.body.classList.contains("light-theme");
      localStorage.setItem("theme", isLightTheme ? "light" : "dark");
    });
  
    // Verifica o tema salvo ao carregar a p√°gina
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "light") {
      document.body.classList.add("light-theme");
    }
  
    // Fun√ß√£o para iniciar a barra de progresso (exemplo "fake")
    function startFakeProgress() {
      let progress = 0;
      progressBar.style.transition = 'width 0.5s ease-out';
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        if (progress < 90) {
          if (progress < 30) progress += 0.8;
          else if (progress < 60) progress += 0.5;
          else progress += 0.2;
          progressBar.style.width = `${progress}%`;
          statusElement.textContent = "Baixando...";
        }
      }, 100);
    }
  
    // Fun√ß√£o para adicionar m√∫sica √† lista de downloads
    function addMusicToList(title, isSuccess = true) {
      const musicItem = document.createElement("p");
      musicItem.textContent = isSuccess ? `${title} baixada com sucesso! üéâ` : title;
      downloadsList.prepend(musicItem);
    }
  
    // Atualiza√ß√£o do progresso via SocketIO
    socket.on("progress", (data) => {
      if (data.message.includes("conclu√≠do")) {
        addMusicToList(data.title);
        if (progressInterval) {
          clearInterval(progressInterval);
          progressBar.style.transition = 'width 0.3s ease-out';
          progressBar.style.width = "100%";
          statusElement.textContent = `Download conclu√≠do! üéâ`;
          downloadButton.disabled = false;
          startTime = null; // reseta o timer
          triggerConfetti(); // Dispara confetes ao concluir o download
        }
      } else {
        if (!startTime) startTime = Date.now();
        const elapsedTime = (Date.now() - startTime) / 1000; // em segundos
        const downloaded = data.downloaded_bytes || 0;
        const total = data.total_bytes || 1;
        const remainingBytes = total - downloaded;
        const downloadSpeed = downloaded / elapsedTime; // bytes por segundo
        const remainingTime = downloadSpeed > 0 ? remainingBytes / downloadSpeed : 0;
        const minutes = Math.floor(remainingTime / 60);
        const seconds = Math.floor(remainingTime % 60);
        progressBar.style.width = `${data.progress}%`;
        statusElement.textContent = `Baixando: ${data.title} - Tempo restante: ${minutes}m ${seconds}s`;
      }
    });
  
    // Buscar informa√ß√µes do v√≠deo assim que a URL for inserida
    urlInput.addEventListener("input", async () => {
      const url = urlInput.value;
      if (url.startsWith("http")) {
        // Exibe a se√ß√£o de informa√ß√µes e mostra mensagem de carregamento
        infoSection.style.display = "block";
        musicInfo.textContent = "Carregando informa√ß√µes...";
        thumbnail.src = "";
  
        try {
          const response = await fetch("/get-info", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url })
          });
          const data = await response.json();
          if (data.success) {
            musicInfo.innerHTML = `
              <strong>T√≠tulo:</strong> ${data.title}<br>
              <strong>Dura√ß√£o:</strong> ${data.duration} segundos<br>
              <strong>Canal:</strong> ${data.channel}<br>
              <strong>Data:</strong> ${data.upload_date}<br>
            `;
            thumbnail.src = data.thumbnail;
          } else {
            musicInfo.textContent = "Erro ao buscar informa√ß√µes.";
            thumbnail.src = "";
          }
        } catch (error) {
          musicInfo.textContent = "Erro ao buscar informa√ß√µes.";
          thumbnail.src = "";
        }
      } else {
        // Oculta a se√ß√£o se a URL n√£o for v√°lida
        infoSection.style.display = "none";
        musicInfo.textContent = "Nenhuma informa√ß√£o dispon√≠vel.";
        thumbnail.src = "";
      }
    });
  
    // Evento do formul√°rio de download
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusElement.textContent = "Iniciando download...";
      progressBar.style.width = "0%";
      downloadButton.disabled = true;
      downloadsList.innerHTML = '';
  
      // Oculta o bloco de informa√ß√µes da m√∫sica ao iniciar o download
      infoSection.style.display = "none";
  
      const formData = new FormData(form);
      const urlValue = urlInput.value;
      if (!urlValue.startsWith("http") || urlValue.trim() === "") {
        statusElement.textContent = "URL inv√°lida. Por favor, insira uma URL v√°lida.";
        progressBar.style.width = "0%";
        downloadButton.disabled = false;
        return;
      }
  
      startFakeProgress();
  
      try {
        const response = await fetch("/download", {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          throw new Error("Erro ao tentar baixar o arquivo. Verifique o servidor.");
        }
        const data = await response.json();
        if (!data.success) {
          throw new Error("Erro ao processar o download.");
        }
      } catch (error) {
        if (progressInterval) clearInterval(progressInterval);
        progressBar.style.width = "0%";
        statusElement.textContent = `${error.message}`;
        downloadButton.disabled = false;
      }
    });
  </script>
</body>
</html>